# FindaLedge 要件定義書

## 1. プロジェクトの目的・背景

FindaLedgeは、RAG (Retrieval-Augmented Generation) アプリケーション向けに、ベクトル検索とキーワード検索を組み合わせた**アンサンブル検索システム**を容易に構築・管理するためのPythonライブラリです。複数のベクトルストア（Chroma, FAISS）やキーワードストア（BM25）のセットアップ、ドキュメントの追加・削除、インデックス管理、そして検索結果の統合（RRF）といった複雑なプロセスを抽象化し、開発者がアプリケーションロジックに集中できるように支援します。

### 1.1 プロジェクトの目的

*   ベクトル検索とキーワード検索を組み合わせたアンサンブル検索基盤の簡単な構築手段を提供。
*   複数のドキュメントストアや埋め込みモデルに対する柔軟な設定オプションを提供。
*   ファイルやディレクトリからの簡単なドキュメント取り込みと自動的な前処理（チャンキング）を実現。
*   Reciprocal Rank Fusion (RRF) による検索結果の自動的な統合機能を提供。
*   LangChain との互換性を保ち、既存の LangChain エコシステム内で利用しやすくする。

### 1.2 プロジェクトの背景

*   RAG において、単一の検索手法（ベクトル検索のみ、キーワード検索のみ）では十分な検索精度が得られないケースの増加。
*   意味的類似性とキーワードのマッチングの両方を考慮したアンサンブル検索の有効性が認識されているが、その構築は複雑。
*   複数の検索コンポーネント（ベクトルDB、キーワードインデックス、埋め込みモデル）の管理と連携に手間がかかる。
*   開発者が検索基盤の構築よりも、LLM を活用したアプリケーション開発自体に注力したいという要求。

## 2. 利用者と困りごと

| 利用者 | ゴール | 制約 | 困りごと |
|---|---|---|---|
| RAG アプリケーション開発者 | - 検索精度の高い RAG アプリを効率的に開発したい<br>- 意味検索とキーワード検索の良い点を組み合わせたい<br>- 検索基盤の実装詳細になるべく関わりたくない | - 複数の検索技術（ベクトルDB、BM25、RRF等）の習得・管理コスト<br>- パフォーマンスとスケーラビリティの考慮 | - **アンサンブル検索システムの構築・管理が複雑**<br>- ベクトルストアやキーワードインデックスの設定・同期が面倒<br>- 検索結果の適切な統合（スコア正規化、RRF等）が難しい<br>- ドキュメントの前処理（ロード、分割）が手間 |
| (FindaLedge を利用したアプリの) エンドユーザー | - 自然な質問やキーワードで必要な情報を正確かつ迅速に見つけたい | - 技術的な知識が少ない<br>- 検索の仕組みを意識したくない | - キーワードだけでは意図した情報が見つからない<br>- 意味は近いがキーワードが異なる情報を見逃す<br>- 検索結果が多すぎる、または無関係な情報が多い |

## 3. 採用する技術スタック

### 3.1 コアライブラリ
| ライブラリ | バージョン | 用途 |
|---|---|---|
| langchain | 最新版 | LLM統合フレームワーク、Document Loaders, Text Splitters, Retrievers |
| langchain-community | 最新版 | Chroma, FAISS, OllamaEmbeddings 等のインテグレーション |
| langchain-openai | 最新版 | OpenAIEmbeddings |
| sentence-transformers | 最新版 | デフォルトの埋め込みモデル（HuggingFaceBgeEmbeddings等） |
| numpy | 最新版 | 数値計算（ベクトル操作等） |
| pydantic | 最新版 | データバリデーション、設定管理 |
| rank_bm25 | 最新版 | BM25キーワード検索（内部で使用） |
| faiss-cpu / faiss-gpu | 最新版 | FAISSベクトルストア用（オプション依存） |
| chromadb | 最新版 | Chromaベクトルストア用（オプション依存） |

### 3.2 開発ツール
| ツール | バージョン | 用途 |
|---|---|---|
| Python | **3.10以上** | 開発言語 |
| uv | 最新版 | パッケージ管理、仮想環境 |
| pytest | 最新版 | テストフレームワーク |
| pytest-cov | 最新版 | テストカバレッジ計測 |
| black | 最新版 | コードフォーマッター |
| isort | 最新版 | インポート整理 |

## 4. 機能（ユースケース）一覧

| 機能ID | 機能カテゴリ | 機能名 | 説明 | 優先度 |
|---|---|---|---|---|
| UC-FL-01 | 初期化・設定 | **FindaLedge 簡単初期化** | 単一の `FindaLedge` クラスでベクトルストア、キーワードストア、埋め込み等をデフォルト設定で初期化 | 高 |
| UC-FL-02 | 初期化・設定 | **柔軟なコンポーネント設定** | 環境変数または引数で、使用するベクトルストア(Chroma/FAISS)、キーワードストア(BM25)、埋め込み(OpenAI/Ollama/SentenceTransformer)、永続化パス等を指定可能 | 高 |
| UC-DM-01 | 文書管理 | **ファイル/ディレクトリからの文書追加** | 指定されたファイルまたはディレクトリ内のファイルを自動で読み込み、パースしてストアに追加 (`add_document`) | 高 |
| UC-DM-02 | 文書管理 | **自動チャンキング** | 文書追加時に、コンテンツタイプに基づいて適切なチャンクサイズで自動的に分割 | 高 |
| UC-DM-03 | 文書管理 | 文書削除 | 指定した（親）ドキュメントIDに基づいて、関連するデータ（親、分割チャンク）をストアから削除 (`remove_document`) | 中 |
| UC-SR-01 | 検索 | **ハイブリッド検索 (RRF)** | ベクトル検索とキーワード検索を同時に実行し、RRFで結果を統合してランキング (`search` デフォルト) | 高 |
| UC-SR-02 | 検索 | 検索モード選択 | `search_mode` 引数で "hybrid", "vector", "keyword" のいずれかを選択可能 | 高 |
| UC-SR-03 | 検索 | 関連コンテキスト取得 | 検索結果を指定された形式（デフォルトはシンプルなテキスト結合）で取得 (`get_context`) | 高 |
| UC-LC-01 | LangChain連携 | **Retrieverインターフェース提供** | `FindaLedge` インスタンスを LangChain の `BaseRetriever` として利用可能にする (`as_retriever`) | 高 |
| UC-IM-01 | インデックス管理 | インデックス永続化/ロード | 指定されたディレクトリに各ストアのインデックスを永続化し、次回初期化時に自動ロード | 高 | 